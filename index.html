<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Granny Horror Game</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background-color: #111;
            color: #fff;
            font-family: 'Courier New', monospace;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            overflow: hidden;
        }
        
        .game-container {
            position: relative;
            width: 800px;
            height: 600px;
            margin: 20px auto;
            border: 2px solid #444;
            box-shadow: 0 0 20px rgba(255, 0, 0, 0.3);
        }
        
        #gameCanvas {
            background-color: #000;
            display: block;
        }
        
        .ui-overlay {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 10;
            pointer-events: none;
        }
        
        .health-bar {
            width: 200px;
            height: 20px;
            background-color: #333;
            border: 1px solid #555;
            margin-bottom: 10px;
        }
        
        .health-fill {
            height: 100%;
            width: 100%;
            background-color: #8B0000;
            transition: width 0.3s;
        }
        
        .day-counter {
            font-size: 16px;
            margin-bottom: 10px;
            color: #ccc;
        }
        
        .instructions {
            position: absolute;
            bottom: 10px;
            left: 10px;
            font-size: 14px;
            color: #aaa;
        }
        
        .game-over, .game-win {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 20;
            display: none;
        }
        
        .game-over h1, .game-win h1 {
            font-size: 48px;
            color: #8B0000;
            margin-bottom: 20px;
            text-shadow: 0 0 10px rgba(255, 0, 0, 0.5);
        }
        
        .game-win h1 {
            color: #006400;
            text-shadow: 0 0 10px rgba(0, 255, 0, 0.5);
        }
        
        .restart-btn {
            padding: 10px 20px;
            background-color: #333;
            color: #fff;
            border: 1px solid #555;
            font-family: 'Courier New', monospace;
            font-size: 18px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .restart-btn:hover {
            background-color: #555;
        }
        
        .mini-map {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 150px;
            height: 150px;
            background-color: rgba(0, 0, 0, 0.7);
            border: 1px solid #555;
            z-index: 10;
            display: none;
        }
        
        .inventory {
            position: absolute;
            bottom: 10px;
            right: 10px;
            display: flex;
            gap: 10px;
            z-index: 10;
        }
        
        .inventory-slot {
            width: 40px;
            height: 40px;
            background-color: rgba(50, 50, 50, 0.7);
            border: 1px solid #666;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }
        
        .item-count {
            position: absolute;
            bottom: 0;
            right: 0;
            font-size: 12px;
            background-color: rgba(0, 0, 0, 0.7);
            padding: 2px 4px;
        }
    </style>
</head>
<body>
    <h1>Granny Horror Game</h1>
    <div class="game-container">
        <canvas id="gameCanvas" width="800" height="600"></canvas>
        
        <div class="ui-overlay">
            <div class="health-bar">
                <div class="health-fill" id="healthFill"></div>
            </div>
            <div class="day-counter" id="dayCounter">Day 1 - 7:00 AM</div>
        </div>
        
        <div class="instructions">
            <p>WASD: Move | H: Hide in Closet | M: Toggle Map | E: Use Item</p>
        </div>
        
        <div class="mini-map" id="miniMap"></div>
        
        <div class="inventory" id="inventory">
            <!-- Inventory slots will be added by JavaScript -->
        </div>
        
        <div class="game-over" id="gameOver">
            <h1>GAME OVER</h1>
            <p>Granny caught you!</p>
            <button class="restart-btn" onclick="restartGame()">Try Again</button>
        </div>
        
        <div class="game-win" id="gameWin">
            <h1>YOU ESCAPED!</h1>
            <p>You survived Granny's house!</p>
            <button class="restart-btn" onclick="restartGame()">Play Again</button>
        </div>
    </div>

    <script>
        // Game variables
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const healthFill = document.getElementById('healthFill');
        const dayCounter = document.getElementById('dayCounter');
        const miniMap = document.getElementById('miniMap');
        const inventory = document.getElementById('inventory');
        const gameOverScreen = document.getElementById('gameOver');
        const gameWinScreen = document.getElementById('gameWin');
        
        // Game state
        let gameState = {
            player: {
                x: 400,
                y: 300,
                width: 20,
                height: 30,
                speed: 3,
                health: 100,
                hidden: false,
                hiddenTime: 0,
                items: []
            },
            granny: {
                x: 200,
                y: 150,
                width: 25,
                height: 40,
                speed: 1.5,
                state: 'patrol', // patrol, chase, search
                targetX: 0,
                targetY: 0,
                awareness: 0,
                lastSeenPlayerX: 0,
                lastSeenPlayerY: 0,
                searchTimer: 0
            },
            map: {
                width: 1600,
                height: 1200,
                rooms: [],
                walls: [],
                doors: [],
                hidingSpots: [],
                items: []
            },
            keys: {
                w: false,
                a: false,
                s: false,
                d: false,
                h: false,
                m: false
            },
            day: 1,
            time: 7.0, // 24-hour format
            gameOver: false,
            gameWin: false,
            mapVisible: false,
            sounds: {
                ambient: null,
                footsteps: null,
                granny: null,
                heartbeat: null
            }
        };

        // Initialize the game
        function init() {
            createMap();
            createItems();
            setupInventory();
            setupEventListeners();
            gameLoop();
        }

        // Create the game map with rooms and walls
        function createMap() {
            // Define rooms
            const rooms = [
                { name: 'Bedroom', x: 100, y: 100, width: 300, height: 300, color: '#2a1f4a' },
                { name: 'Hallway', x: 400, y: 100, width: 200, height: 600, color: '#3a2f5a' },
                { name: 'Living Room', x: 600, y: 100, width: 400, height: 300, color: '#2a3f4a' },
                { name: 'Kitchen', x: 600, y: 400, width: 400, height: 300, color: '#4a2f3a' },
                { name: 'Bathroom', x: 100, y: 400, width: 300, height: 200, color: '#2a4a3f' },
                { name: 'Storage', x: 100, y: 600, width: 300, height: 200, color: '#4a4a2a' }
            ];
            
            gameState.map.rooms = rooms;
            
            // Define walls (collision boundaries)
            // Outer walls
            gameState.map.walls.push({ x: 0, y: 0, width: 1600, height: 20 }); // Top
            gameState.map.walls.push({ x: 0, y: 0, width: 20, height: 1200 }); // Left
            gameState.map.walls.push({ x: 0, y: 1180, width: 1600, height: 20 }); // Bottom
            gameState.map.walls.push({ x: 1580, y: 0, width: 20, height: 1200 }); // Right
            
            // Room walls
            gameState.map.walls.push({ x: 100, y: 100, width: 300, height: 20 }); // Bedroom top
            gameState.map.walls.push({ x: 100, y: 100, width: 20, height: 300 }); // Bedroom left
            gameState.map.walls.push({ x: 380, y: 100, width: 20, height: 300 }); // Bedroom right
            gameState.map.walls.push({ x: 100, y: 380, width: 300, height: 20 }); // Bedroom bottom
            
            gameState.map.walls.push({ x: 400, y: 100, width: 200, height: 20 }); // Hallway top
            gameState.map.walls.push({ x: 400, y: 100, width: 20, height: 600 }); // Hallway left
            gameState.map.walls.push({ x: 580, y: 100, width: 20, height: 600 }); // Hallway right
            gameState.map.walls.push({ x: 400, y: 680, width: 200, height: 20 }); // Hallway bottom
            
            // Add more walls to create proper room separation
            gameState.map.walls.push({ x: 600, y: 100, width: 400, height: 20 }); // Living Room top
            gameState.map.walls.push({ x: 600, y: 100, width: 20, height: 300 }); // Living Room left
            gameState.map.walls.push({ x: 980, y: 100, width: 20, height: 300 }); // Living Room right
            gameState.map.walls.push({ x: 600, y: 380, width: 400, height: 20 }); // Living Room bottom
            
            gameState.map.walls.push({ x: 600, y: 400, width: 400, height: 20 }); // Kitchen top
            gameState.map.walls.push({ x: 600, y: 400, width: 20, height: 300 }); // Kitchen left
            gameState.map.walls.push({ x: 980, y: 400, width: 20, height: 300 }); // Kitchen right
            gameState.map.walls.push({ x: 600, y: 680, width: 400, height: 20 }); // Kitchen bottom
            
            gameState.map.walls.push({ x: 100, y: 400, width: 300, height: 20 }); // Bathroom top
            gameState.map.walls.push({ x: 100, y: 400, width: 20, height: 200 }); // Bathroom left
            gameState.map.walls.push({ x: 380, y: 400, width: 20, height: 200 }); // Bathroom right
            gameState.map.walls.push({ x: 100, y: 590, width: 300, height: 20 }); // Bathroom bottom
            
            gameState.map.walls.push({ x: 100, y: 600, width: 300, height: 20 }); // Storage top
            gameState.map.walls.push({ x: 100, y: 600, width: 20, height: 200 }); // Storage left
            gameState.map.walls.push({ x: 380, y: 600, width: 20, height: 200 }); // Storage right
            gameState.map.walls.push({ x: 100, y: 780, width: 300, height: 20 }); // Storage bottom
            
            // Define doors (openings in walls)
            gameState.map.doors = [
                { x: 380, y: 220, width: 20, height: 60, room1: 'Bedroom', room2: 'Hallway', locked: false },
                { x: 400, y: 220, width: 20, height: 60, room1: 'Hallway', room2: 'Bedroom', locked: false },
                { x: 580, y: 220, width: 20, height: 60, room1: 'Hallway', room2: 'Living Room', locked: false },
                { x: 600, y: 220, width: 20, height: 60, room1: 'Living Room', room2: 'Hallway', locked: false },
                { x: 580, y: 520, width: 20, height: 60, room1: 'Hallway', room2: 'Kitchen', locked: false },
                { x: 600, y: 520, width: 20, height: 60, room1: 'Kitchen', room2: 'Hallway', locked: false },
                { x: 380, y: 480, width: 20, height: 60, room1: 'Bathroom', room2: 'Hallway', locked: false },
                { x: 400, y: 480, width: 20, height: 60, room1: 'Hallway', room2: 'Bathroom', locked: false },
                { x: 380, y: 680, width: 20, height: 60, room1: 'Storage', room2: 'Hallway', locked: true },
                { x: 400, y: 680, width: 20, height: 60, room1: 'Hallway', room2: 'Storage', locked: true }
            ];
            
            // Define hiding spots (closets)
            gameState.map.hidingSpots = [
                { x: 120, y: 120, width: 60, height: 80, room: 'Bedroom' },
                { x: 650, y: 120, width: 60, height: 80, room: 'Living Room' },
                { x: 120, y: 620, width: 60, height: 80, room: 'Storage' }
            ];
            
            // Set player starting position in the bedroom
            gameState.player.x = 200;
            gameState.player.y = 200;
            
            // Set Granny starting position in the kitchen
            gameState.granny.x = 700;
            gameState.granny.y = 500;
        }

        // Create items to collect
        function createItems() {
            gameState.map.items = [
                { x: 250, y: 250, width: 15, height: 15, type: 'key', room: 'Bedroom', collected: false, icon: 'üîë' },
                { x: 750, y: 200, width: 15, height: 15, type: 'hammer', room: 'Living Room', collected: false, icon: 'üî®' },
                { x: 700, y: 550, width: 15, height: 15, type: 'screwdriver', room: 'Kitchen', collected: false, icon: 'ü™õ' },
                { x: 200, y: 450, width: 15, height: 15, type: 'battery', room: 'Bathroom', collected: false, icon: 'üîã' },
                { x: 200, y: 650, width: 15, height: 15, type: 'masterKey', room: 'Storage', collected: false, icon: 'üóùÔ∏è' }
            ];
        }

        // Setup inventory UI
        function setupInventory() {
            inventory.innerHTML = '';
            for (let i = 0; i < 5; i++) {
                const slot = document.createElement('div');
                slot.className = 'inventory-slot';
                slot.id = `slot${i}`;
                inventory.appendChild(slot);
            }
            updateInventory();
        }

        // Update inventory display
        function updateInventory() {
            for (let i = 0; i < 5; i++) {
                const slot = document.getElementById(`slot${i}`);
                slot.innerHTML = '';
                
                if (i < gameState.player.items.length) {
                    const item = gameState.player.items[i];
                    slot.textContent = item.icon;
                    
                    // Show count if multiple of same type
                    if (item.count && item.count > 1) {
                        const count = document.createElement('div');
                        count.className = 'item-count';
                        count.textContent = item.count;
                        slot.appendChild(count);
                    }
                }
            }
        }

        // Setup keyboard event listeners
        function setupEventListeners() {
            document.addEventListener('keydown', (e) => {
                if (e.key === 'w' || e.key === 'W') gameState.keys.w = true;
                if (e.key === 'a' || e.key === 'A') gameState.keys.a = true;
                if (e.key === 's' || e.key === 'S') gameState.keys.s = true;
                if (e.key === 'd' || e.key === 'D') gameState.keys.d = true;
                if (e.key === 'h' || e.key === 'H') gameState.keys.h = true;
                if (e.key === 'm' || e.key === 'M') toggleMap();
                if (e.key === 'e' || e.key === 'E') useItem();
            });
            
            document.addEventListener('keyup', (e) => {
                if (e.key === 'w' || e.key === 'W') gameState.keys.w = false;
                if (e.key === 'a' || e.key === 'A') gameState.keys.a = false;
                if (e.key === 's' || e.key === 'S') gameState.keys.s = false;
                if (e.key === 'd' || e.key === 'D') gameState.keys.d = false;
                if (e.key === 'h' || e.key === 'H') gameState.keys.h = false;
            });
        }

        // Toggle mini-map visibility
        function toggleMap() {
            gameState.mapVisible = !gameState.mapVisible;
            miniMap.style.display = gameState.mapVisible ? 'block' : 'none';
        }

        // Use item from inventory
        function useItem() {
            if (gameState.player.items.length === 0) return;
            
            const item = gameState.player.items[0]; // Use first item
            
            // Check if player is near a locked door
            for (const door of gameState.map.doors) {
                if (door.locked && isNear(gameState.player, door, 50)) {
                    if (item.type === 'key' || item.type === 'masterKey') {
                        door.locked = false;
                        removeItemFromInventory(item.type);
                        // Play unlock sound
                        return;
                    }
                }
            }
            
            // Check if player is near storage room with hammer
            const storageDoor = gameState.map.doors.find(d => d.room2 === 'Storage');
            if (storageDoor && storageDoor.locked && isNear(gameState.player, storageDoor, 50)) {
                if (item.type === 'hammer') {
                    storageDoor.locked = false;
                    removeItemFromInventory(item.type);
                    // Play break sound
                    return;
                }
            }
        }

        // Remove item from inventory
        function removeItemFromInventory(itemType) {
            const index = gameState.player.items.findIndex(item => item.type === itemType);
            if (index !== -1) {
                gameState.player.items.splice(index, 1);
                updateInventory();
            }
        }

        // Check if two objects are near each other
        function isNear(obj1, obj2, distance) {
            const dx = obj1.x - obj2.x;
            const dy = obj1.y - obj2.y;
            return Math.sqrt(dx * dx + dy * dy) < distance;
        }

        // Main game loop
        function gameLoop() {
            if (gameState.gameOver || gameState.gameWin) {
                return;
            }
            
            update();
            render();
            requestAnimationFrame(gameLoop);
        }

        // Update game state
        function update() {
            updatePlayer();
            updateGranny();
            updateItems();
            updateTime();
            checkCollisions();
            checkWinCondition();
        }

        // Update player position and state
        function updatePlayer() {
            if (gameState.player.hidden) {
                gameState.player.hiddenTime++;
                // Reduce Granny's awareness when hidden
                gameState.granny.awareness = Math.max(0, gameState.granny.awareness - 0.5);
                
                // Auto exit hiding after 5 seconds
                if (gameState.player.hiddenTime > 300) {
                    gameState.player.hidden = false;
                    gameState.player.hiddenTime = 0;
                }
                return;
            }
            
            let dx = 0;
            let dy = 0;
            
            if (gameState.keys.w) dy -= gameState.player.speed;
            if (gameState.keys.s) dy += gameState.player.speed;
            if (gameState.keys.a) dx -= gameState.player.speed;
            if (gameState.keys.d) dx += gameState.player.speed;
            
            // Normalize diagonal movement
            if (dx !== 0 && dy !== 0) {
                dx *= 0.707;
                dy *= 0.707;
            }
            
            // Check for collisions before moving
            const newX = gameState.player.x + dx;
            const newY = gameState.player.y + dy;
            
            if (!checkWallCollision(newX, gameState.player.y)) {
                gameState.player.x = newX;
            }
            
            if (!checkWallCollision(gameState.player.x, newY)) {
                gameState.player.y = newY;
            }
            
            // Check for hiding spot interaction
            if (gameState.keys.h) {
                for (const spot of gameState.map.hidingSpots) {
                    if (isColliding(gameState.player, spot)) {
                        gameState.player.hidden = true;
                        gameState.player.hiddenTime = 0;
                        break;
                    }
                }
            }
            
            // Keep player within map bounds
            gameState.player.x = Math.max(20, Math.min(gameState.map.width - 20, gameState.player.x));
            gameState.player.y = Math.max(20, Math.min(gameState.map.height - 20, gameState.player.y));
        }

        // Update Granny AI
        function updateGranny() {
            const granny = gameState.granny;
            const player = gameState.player;
            
            // Calculate distance to player
            const dx = player.x - granny.x;
            const dy = player.y - granny.y;
            const distance = Math.sqrt(dx * dx + dy * dy);
            
            // Update Granny's state based on player visibility
            if (!player.hidden && distance < 200 && hasLineOfSight(granny, player)) {
                granny.state = 'chase';
                granny.awareness = 100;
                granny.lastSeenPlayerX = player.x;
                granny.lastSeenPlayerY = player.y;
                granny.searchTimer = 0;
            } else if (granny.state === 'chase') {
                granny.state = 'search';
                granny.searchTimer = 300; // 5 seconds of searching
            } else if (granny.state === 'search' && granny.searchTimer > 0) {
                granny.searchTimer--;
            } else {
                granny.state = 'patrol';
                granny.awareness = Math.max(0, granny.awareness - 0.2);
            }
            
            // Move Granny based on state
            switch (granny.state) {
                case 'patrol':
                    patrolBehavior();
                    break;
                case 'chase':
                    chaseBehavior();
                    break;
                case 'search':
                    searchBehavior();
                    break;
            }
            
            // Keep Granny within map bounds
            granny.x = Math.max(20, Math.min(gameState.map.width - 20, granny.x));
            granny.y = Math.max(20, Math.min(gameState.map.height - 20, granny.y));
        }

        // Granny patrol behavior
        function patrolBehavior() {
            const granny = gameState.granny;
            
            // If no target or reached target, set new random target
            if (!granny.targetX || !granny.targetY || 
                (Math.abs(granny.x - granny.targetX) < 10 && Math.abs(granny.y - granny.targetY) < 10)) {
                
                // Get a random room
                const randomRoom = gameState.map.rooms[Math.floor(Math.random() * gameState.map.rooms.length)];
                
                // Set target to random position in that room
                granny.targetX = randomRoom.x + 50 + Math.random() * (randomRoom.width - 100);
                granny.targetY = randomRoom.y + 50 + Math.random() * (randomRoom.height - 100);
            }
            
            // Move towards target
            const dx = granny.targetX - granny.x;
            const dy = granny.targetY - granny.y;
            const distance = Math.sqrt(dx * dx + dy * dy);
            
            if (distance > 0) {
                granny.x += (dx / distance) * granny.speed;
                granny.y += (dy / distance) * granny.speed;
            }
        }

        // Granny chase behavior
        function chaseBehavior() {
            const granny = gameState.granny;
            const player = gameState.player;
            
            // Move towards player
            const dx = player.x - granny.x;
            const dy = player.y - granny.y;
            const distance = Math.sqrt(dx * dx + dy * dy);
            
            if (distance > 0) {
                granny.x += (dx / distance) * granny.speed * 1.5; // Faster when chasing
                granny.y += (dy / distance) * granny.speed * 1.5;
            }
            
            // Check if caught player
            if (distance < 30) {
                playerCaught();
            }
        }

        // Granny search behavior
        function searchBehavior() {
            const granny = gameState.granny;
            
            // Move towards last seen player position
            const dx = granny.lastSeenPlayerX - granny.x;
            const dy = granny.lastSeenPlayerY - granny.y;
            const distance = Math.sqrt(dx * dx + dy * dy);
            
            if (distance > 0) {
                granny.x += (dx / distance) * granny.speed;
                granny.y += (dy / distance) * granny.speed;
            }
            
            // Wander a bit while searching
            if (Math.random() < 0.02) {
                granny.lastSeenPlayerX += (Math.random() - 0.5) * 100;
                granny.lastSeenPlayerY += (Math.random() - 0.5) * 100;
            }
        }

        // Check if Granny has line of sight to player
        function hasLineOfSight(granny, player) {
            // Simple line of sight check - in a real game you'd want to check against walls
            // For this demo, we'll just use distance and a simple angle check
            const dx = player.x - granny.x;
            const dy = player.y - granny.y;
            const distance = Math.sqrt(dx * dx + dy * dy);
            
            // Check if there's a wall between them (simplified)
            for (const wall of gameState.map.walls) {
                // Skip if it's a door that's not locked
                const isDoor = gameState.map.doors.some(door => 
                    door.x === wall.x && door.y === wall.y && door.width === wall.width && door.height === wall.height && !door.locked);
                
                if (isDoor) continue;
                
                // Simple line-rectangle intersection (would need more sophisticated in a real game)
                if (lineIntersectsRect(granny.x, granny.y, player.x, player.y, wall)) {
                    return false;
                }
            }
            
            return true;
        }

        // Check if a line intersects a rectangle
        function lineIntersectsRect(x1, y1, x2, y2, rect) {
            // Check if either endpoint is inside the rectangle
            if (x1 >= rect.x && x1 <= rect.x + rect.width && y1 >= rect.y && y1 <= rect.y + rect.height) return true;
            if (x2 >= rect.x && x2 <= rect.x + rect.width && y2 >= rect.y && y2 <= rect.y + rect.height) return true;
            
            // Check if the line intersects any of the rectangle's edges
            return (
                lineIntersectsLine(x1, y1, x2, y2, rect.x, rect.y, rect.x + rect.width, rect.y) ||
                lineIntersectsLine(x1, y1, x2, y2, rect.x + rect.width, rect.y, rect.x + rect.width, rect.y + rect.height) ||
                lineIntersectsLine(x1, y1, x2, y2, rect.x, rect.y + rect.height, rect.x + rect.width, rect.y + rect.height) ||
                lineIntersectsLine(x1, y1, x2, y2, rect.x, rect.y, rect.x, rect.y + rect.height)
            );
        }

        // Check if two lines intersect
        function lineIntersectsLine(x1, y1, x2, y2, x3, y3, x4, y4) {
            const den = (y4 - y3) * (x2 - x1) - (x4 - x3) * (y2 - y1);
            if (den === 0) return false; // Lines are parallel
            
            const ua = ((x4 - x3) * (y1 - y3) - (y4 - y3) * (x1 - x3)) / den;
            const ub = ((x2 - x1) * (y1 - y3) - (y2 - y1) * (x1 - x3)) / den;
            
            return ua >= 0 && ua <= 1 && ub >= 0 && ub <= 1;
        }

        // Update item collection
        function updateItems() {
            for (const item of gameState.map.items) {
                if (!item.collected && isColliding(gameState.player, item)) {
                    item.collected = true;
                    
                    // Check if player already has this item type
                    const existingItem = gameState.player.items.find(i => i.type === item.type);
                    if (existingItem) {
                        existingItem.count = (existingItem.count || 1) + 1;
                    } else {
                        gameState.player.items.push({
                            type: item.type,
                            icon: item.icon,
                            count: 1
                        });
                    }
                    
                    updateInventory();
                }
            }
        }

        // Update game time
        function updateTime() {
            gameState.time += 0.01; // Time passes slowly
            
            // Advance day every 24 "hours"
            if (gameState.time >= 24) {
                gameState.time = 7; // Reset to 7 AM
                gameState.day++;
                
                // Game over after 5 days
                if (gameState.day > 5) {
                    gameState.gameOver = true;
                    gameOverScreen.style.display = 'flex';
                }
            }
            
            // Update day counter display
            const hours = Math.floor(gameState.time);
            const minutes = Math.floor((gameState.time - hours) * 60);
            const ampm = hours >= 12 ? 'PM' : 'AM';
            const displayHours = hours % 12 || 12;
            dayCounter.textContent = `Day ${gameState.day} - ${displayHours}:${minutes.toString().padStart(2, '0')} ${ampm}`;
        }

        // Check for collisions
        function checkCollisions() {
            // Player caught by Granny
            if (!gameState.player.hidden && isColliding(gameState.player, gameState.granny)) {
                playerCaught();
            }
        }

        // Check if player has won
        function checkWinCondition() {
            // Check if player has all items and is near an exit
            const hasAllItems = 
                gameState.player.items.some(i => i.type === 'key') &&
                gameState.player.items.some(i => i.type === 'masterKey');
            
            // Check if player is near the front door (simplified)
            const frontDoor = { x: 800, y: 100, width: 50, height: 20 };
            if (hasAllItems && isNear(gameState.player, frontDoor, 50)) {
                gameState.gameWin = true;
                gameWinScreen.style.display = 'flex';
            }
        }

        // Player caught by Granny
        function playerCaught() {
            gameState.player.health -= 25;
            healthFill.style.width = `${gameState.player.health}%`;
            
            // Reset player position to bedroom
            gameState.player.x = 200;
            gameState.player.y = 200;
            gameState.player.hidden = false;
            
            // Reset Granny
            gameState.granny.x = 700;
            gameState.granny.y = 500;
            gameState.granny.state = 'patrol';
            gameState.granny.awareness = 0;
            
            // Game over if health reaches 0
            if (gameState.player.health <= 0) {
                gameState.gameOver = true;
                gameOverScreen.style.display = 'flex';
            }
        }

        // Check if two objects are colliding
        function isColliding(obj1, obj2) {
            return obj1.x < obj2.x + obj2.width &&
                   obj1.x + obj1.width > obj2.x &&
                   obj1.y < obj2.y + obj2.height &&
                   obj1.y + obj1.height > obj2.y;
        }

        // Check for wall collisions
        function checkWallCollision(x, y) {
            const player = {
                x: x,
                y: y,
                width: gameState.player.width,
                height: gameState.player.height
            };
            
            for (const wall of gameState.map.walls) {
                // Skip if it's a door that's not locked
                const isDoor = gameState.map.doors.some(door => 
                    door.x === wall.x && door.y === wall.y && door.width === wall.width && door.height === wall.height && !door.locked);
                
                if (isDoor) continue;
                
                if (isColliding(player, wall)) {
                    return true;
                }
            }
            
            return false;
        }

        // Render the game
        function render() {
            // Clear canvas
            ctx.fillStyle = '#000';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Calculate camera offset to follow player
            const cameraX = gameState.player.x - canvas.width / 2;
            const cameraY = gameState.player.y - canvas.height / 2;
            
            // Draw rooms
            for (const room of gameState.map.rooms) {
                ctx.fillStyle = room.color;
                ctx.fillRect(room.x - cameraX, room.y - cameraY, room.width, room.height);
                
                // Draw room name
                ctx.fillStyle = '#fff';
                ctx.font = '12px Arial';
                ctx.fillText(room.name, room.x - cameraX + 10, room.y - cameraY + 20);
            }
            
            // Draw walls
            ctx.fillStyle = '#555';
            for (const wall of gameState.map.walls) {
                ctx.fillRect(wall.x - cameraX, wall.y - cameraY, wall.width, wall.height);
            }
            
            // Draw doors
            for (const door of gameState.map.doors) {
                ctx.fillStyle = door.locked ? '#8B0000' : '#8B4513';
                ctx.fillRect(door.x - cameraX, door.y - cameraY, door.width, door.height);
            }
            
            // Draw hiding spots
            for (const spot of gameState.map.hidingSpots) {
                ctx.fillStyle = '#333';
                ctx.fillRect(spot.x - cameraX, spot.y - cameraY, spot.width, spot.height);
                ctx.fillStyle = '#666';
                ctx.fillText('Closet', spot.x - cameraX + 5, spot.y - cameraY + 15);
            }
            
            // Draw items
            for (const item of gameState.map.items) {
                if (!item.collected) {
                    ctx.fillStyle = '#FFD700';
                    ctx.fillRect(item.x - cameraX, item.y - cameraY, item.width, item.height);
                    ctx.fillStyle = '#000';
                    ctx.font = '10px Arial';
                    ctx.fillText(item.icon, item.x - cameraX + 2, item.y - cameraY + 12);
                }
            }
            
            // Draw Granny
            if (!gameState.player.hidden || gameState.granny.state === 'chase') {
                ctx.fillStyle = gameState.granny.state === 'chase' ? '#8B0000' : '#800080';
                ctx.fillRect(gameState.granny.x - cameraX, gameState.granny.y - cameraY, gameState.granny.width, gameState.granny.height);
                
                // Draw Granny's face
                ctx.fillStyle = '#fff';
                ctx.fillRect(gameState.granny.x - cameraX + 5, gameState.granny.y - cameraY + 10, 5, 5);
                ctx.fillRect(gameState.granny.x - cameraX + 15, gameState.granny.y - cameraY + 10, 5, 5);
                ctx.fillRect(gameState.granny.x - cameraX + 5, gameState.granny.y - cameraY + 20, 15, 5);
            }
            
            // Draw player
            if (!gameState.player.hidden) {
                ctx.fillStyle = '#00FF00';
                ctx.fillRect(gameState.player.x - cameraX, gameState.player.y - cameraY, gameState.player.width, gameState.player.height);
                
                // Draw player face
                ctx.fillStyle = '#000';
                ctx.fillRect(gameState.player.x - cameraX + 5, gameState.player.y - cameraY + 10, 5, 5);
                ctx.fillRect(gameState.player.x - cameraX + 15, gameState.player.y - cameraY + 10, 5, 5);
                ctx.fillRect(gameState.player.x - cameraX + 5, gameState.player.y - cameraY + 20, 10, 5);
            } else {
                // Draw hidden indicator
                ctx.fillStyle = '#FFFF00';
                ctx.font = '16px Arial';
                ctx.fillText('HIDING', gameState.player.x - cameraX - 20, gameState.player.y - cameraY - 10);
            }
            
            // Draw mini-map if visible
            if (gameState.mapVisible) {
                drawMiniMap();
            }
            
            // Draw Granny awareness meter
            ctx.fillStyle = '#333';
            ctx.fillRect(10, 40, 150, 20);
            ctx.fillStyle = `rgb(${Math.floor(gameState.granny.awareness * 2.55)}, ${Math.floor(255 - gameState.granny.awareness * 2.55)}, 0)`;
            ctx.fillRect(10, 40, gameState.granny.awareness * 1.5, 20);
            ctx.fillStyle = '#fff';
            ctx.font = '12px Arial';
            ctx.fillText('Granny Awareness', 15, 35);
        }

        // Draw mini-map
        function drawMiniMap() {
            const mapCtx = miniMap.getContext('2d');
            mapCtx.fillStyle = 'rgba(0, 0, 0, 0.7)';
            mapCtx.fillRect(0, 0, miniMap.width, miniMap.height);
            
            // Calculate scale
            const scaleX = miniMap.width / gameState.map.width;
            const scaleY = miniMap.height / gameState.map.height;
            
            // Draw rooms
            for (const room of gameState.map.rooms) {
                mapCtx.fillStyle = room.color;
                mapCtx.fillRect(room.x * scaleX, room.y * scaleY, room.width * scaleX, room.height * scaleY);
            }
            
            // Draw player
            mapCtx.fillStyle = '#00FF00';
            mapCtx.fillRect(gameState.player.x * scaleX - 2, gameState.player.y * scaleY - 2, 4, 4);
            
            // Draw Granny
            mapCtx.fillStyle = '#FF0000';
            mapCtx.fillRect(gameState.granny.x * scaleX - 2, gameState.granny.y * scaleY - 2, 4, 4);
            
            // Draw items
            for (const item of gameState.map.items) {
                if (!item.collected) {
                    mapCtx.fillStyle = '#FFD700';
                    mapCtx.fillRect(item.x * scaleX - 1, item.y * scaleY - 1, 2, 2);
                }
            }
        }

        // Restart game
        function restartGame() {
            // Reset game state
            gameState.player.x = 200;
            gameState.player.y = 200;
            gameState.player.health = 100;
            gameState.player.hidden = false;
            gameState.player.hiddenTime = 0;
            gameState.player.items = [];
            
            gameState.granny.x = 700;
            gameState.granny.y = 500;
            gameState.granny.state = 'patrol';
            gameState.granny.awareness = 0;
            
            gameState.day = 1;
            gameState.time = 7.0;
            gameState.gameOver = false;
            gameState.gameWin = false;
            
            // Reset items
            for (const item of gameState.map.items) {
                item.collected = false;
            }
            
            // Reset doors
            for (const door of gameState.map.doors) {
                if (door.room2 === 'Storage') {
                    door.locked = true;
                } else {
                    door.locked = false;
                }
            }
            
            // Update UI
            healthFill.style.width = '100%';
            gameOverScreen.style.display = 'none';
            gameWinScreen.style.display = 'none';
            updateInventory();
            
            // Restart game loop
            gameLoop();
        }

        // Start the game
        init();
    </script>
</body>
</html>
